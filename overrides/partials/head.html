{% raw %}
<script>
  // Set the theme *before* anything else
  const theme = localStorage.getItem('selectedTheme') || 'shiny';
  document.documentElement.setAttribute('data-theme', theme);
  swapLogo();

  // Inject theme stylesheet immediately
  const link = document.createElement('link');
  link.id = 'dynamic-theme-css';
  link.rel = 'stylesheet';
  link.href = `/many/assets/css/themes/${theme}.css`;

  // Insert before any other <link> or <style> tags
  const firstStyle = [...document.head.children].find(el =>
    el.tagName === 'STYLE' || el.tagName === 'LINK'
  );
  if (firstStyle) {
    document.head.insertBefore(link, firstStyle);
  } else {
    document.head.appendChild(link);
  }
</script>

<style>
  /* Fallback background for initial paint */
  html, body {
    background-color: #151515 !important;
  }

  :root {
    --md-default-bg-color: #151515 !important;
  }

  /* Disable transition flickers temporarily */
  * {
    transition: none !important;
  }
</style>
{% endraw %}
